name: Run job

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  processRepos:
    name: Process repos
    env:
      user: samsmithnz
    strategy:
      matrix:
        repo: ['samsmithnz/RepoAutomationUnitTests'] #, 'samsmithnz/RepoAutomation', 'samsmithnz/RepoGovernance']
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        repository: ${{ matrix.repo }}
        token: ${{ secrets.PAT_TOKEN }}
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
    - name: Restore dependencies
      run: dotnet restore src
    - name: Scan and update outdated NuGet packages
      shell: pwsh
      run: |
        cd src 
        $result = dotnet list package --outdated --format json
        write-host "Results!"
        write-host $result
        if ($result.length -gt 40000)
        {
          write-host "Result is too large to be assigned to an environment variable."
        }
        $owner = "${{ matrix.repo }}".split('/')[0]
        $repo = "${{ matrix.repo }}".split('/')[1]
        $NuGetPayload = @{
          User = "${{ env.user }}",
          Owner = $owner,
          Repo = $repo,
          JsonPayload = $result,
          PayloadType = "Outdated"
        } | ConvertTo-Json
        Invoke-WebRequest -Uri https://repogovernance-prod-eu-service.azurewebsites.net/api/SummaryItems/UpdateSummaryItemNuGetPackageStats -Method POST -Body $NuGetPayload
